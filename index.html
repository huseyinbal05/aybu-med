<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AYBU Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .time-connector {
            position: absolute;
            left: 23px;
            top: 45px;
            bottom: -20px;
            width: 2px;
            background: #f1f5f9;
            z-index: 0;
        }
        .last-item .time-connector { display: none; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .card-enter {
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .anim-slide-right { animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .anim-slide-left { animation: slideInLeft 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .glow-border { position: relative; background: white; z-index: 1; transition: transform 0.3s ease; }
        .glow-border::before {
            content: ""; position: absolute; inset: -2px; border-radius: 20px;
            background: linear-gradient(135deg, #60a5fa, #8b5cf6, #3b82f6);
            background-size: 200% 200%; animation: gradientMove 3s ease infinite; z-index: -1; opacity: 0.7;
        }
        @keyframes gradientMove { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }

        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-press:active { transform: scale(0.92); }

        .progress-container { height: 3px; width: 100%; background: #f1f5f9; position: absolute; bottom: 0; left: 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; transition: width 1s linear; border-radius: 0 2px 2px 0; }

        .toggle-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; }
        .toggle-btn.active { background-color: white; color: #2563EB; border-color: #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .toggle-btn.inactive { background-color: transparent; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-32">

    <header class="glass-header sticky top-0 z-50 px-4 pt-3 pb-2 shadow-sm transition-all duration-300">
        <div class="max-w-md mx-auto flex flex-col gap-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="phase-icon" class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white font-extrabold text-sm shadow-lg shadow-blue-200/50 transform transition-transform hover:rotate-3">
                        D1
                    </div>
                    <div>
                        <h1 id="txt-title" class="font-extrabold text-sm leading-tight text-slate-900 tracking-tight">Phase I</h1>
                        <p id="txt-subtitle" class="text-[10px] text-slate-500 font-bold tracking-wide uppercase">AYBU Medicine</p>
                    </div>
                </div>
                <div class="flex bg-slate-100/80 p-1 rounded-lg">
                    <button onclick="setLanguage('TR')" id="btn-tr" class="toggle-btn btn-press px-3 py-1.5 text-[10px] font-bold rounded-md">TR</button>
                    <button onclick="setLanguage('EN')" id="btn-en" class="toggle-btn btn-press px-3 py-1.5 text-[10px] font-bold rounded-md">EN</button>
                </div>
            </div>

            <div class="flex items-center justify-between gap-2 bg-slate-100/80 p-1.5 rounded-2xl backdrop-blur-sm border border-white/50 shadow-sm">
                <button onclick="changeDay(-1)" class="btn-press w-10 h-10 flex flex-none items-center justify-center rounded-xl bg-white text-slate-400 shadow-sm hover:text-blue-600 transition-colors">
                    <i class="fas fa-chevron-left text-xs"></i>
                </button>
                
                <div class="relative flex-1 group h-10">
                    <input type="date" id="datePicker" class="opacity-0 absolute inset-0 w-full h-full z-20 cursor-pointer">
                    <div class="flex items-center justify-center gap-3 w-full h-full bg-white border border-slate-200/60 rounded-xl shadow-sm group-hover:border-blue-300 group-active:bg-slate-50 transition-all px-2">
                        <div id="dateDisplay" class="flex-1 text-center select-none"></div>
                    </div>
                </div>

                <button onclick="changeDay(1)" class="btn-press w-10 h-10 flex flex-none items-center justify-center rounded-xl bg-white text-slate-400 shadow-sm hover:text-blue-600 transition-colors">
                    <i class="fas fa-chevron-right text-xs"></i>
                </button>
            </div>
        </div>
        <div class="progress-container">
            <div id="dayProgressBar" class="progress-bar"></div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">

        <div id="uploadSection" class="hidden bg-white rounded-[2rem] shadow-xl shadow-slate-200/60 border border-slate-100 p-8 text-center mt-6 transition-all hover:translate-y-[-2px]">
            <div class="animate-float w-20 h-20 bg-gradient-to-tr from-blue-50 to-indigo-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-5 text-3xl shadow-inner border border-blue-100">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h2 id="txt-load-title" class="text-xl font-bold text-slate-800 mb-2 tracking-tight">Load Schedule</h2>
            <p id="txt-load-desc" class="text-slate-500 text-sm mb-4 px-2 leading-relaxed">Upload the 2025-2026 TR-ING Excel file.</p>
            <p id="fetch-error-msg" class="hidden text-rose-500 text-xs font-bold bg-rose-50 p-2 rounded-lg mb-6 border border-rose-100">
                <i class="fas fa-exclamation-circle mr-1"></i> Auto-load failed.
            </p>
            <label class="block w-full cursor-pointer group btn-press">
                <span class="block w-full bg-blue-600 group-hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-folder-open"></i> <span id="txt-select-file">Select File</span>
                </span>
                <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden">
            </label>
        </div>

        <div id="scheduleContainer" class="hidden space-y-0 mt-4 relative pl-1 pb-10"></div>

        <div id="emptyState" class="hidden text-center py-24 px-6 card-enter">
            <div id="emptyIcon" class="text-6xl text-slate-200 mb-5 transform transition-transform hover:scale-110 duration-300 inline-block"><i class="fas fa-calendar-check"></i></div>
            <h3 id="txt-empty-title" class="text-xl font-bold text-slate-700">No Classes Found</h3>
            <p id="txt-empty-desc" class="text-slate-400 text-sm mt-2 max-w-[250px] mx-auto leading-relaxed font-medium">Check the date or switch language.</p>
        </div>

        <div id="loadingState" class="hidden text-center py-32">
            <div class="inline-block relative">
                <div class="w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <p id="txt-loading" class="text-slate-400 text-xs mt-4 font-bold tracking-widest uppercase animate-pulse">Loading...</p>
        </div>

    </main>
    
    <button id="resetBtn" onclick="resetApp()" class="hidden fixed bottom-8 right-6 bg-white text-rose-500 w-14 h-14 rounded-2xl shadow-2xl shadow-rose-900/10 border border-rose-50 flex items-center justify-center z-40 btn-press transition-all hover:bg-rose-50 group" title="Reset">
        <i class="fas fa-sync-alt text-lg group-hover:rotate-180 transition-transform duration-700"></i>
    </button>

    <script>
        const SCHEDULE_FILENAME = 'schedule.xlsx'; 
        let workbookData = null;
        const STORAGE_KEY_DATA = 'aybu_data_v43'; 
        const STORAGE_KEY_LANG = 'aybu_lang_v43';
        let currentLang = 'EN'; 

        const TRANSLATIONS = {
            EN: {
                title: "Phase I", subtitle: "AYBU Medicine", loadTitle: "Welcome Back", loadDesc: "Upload your schedule file.",
                selectFile: "Browse Files", emptyTitle: "No Classes Found", emptyDesc: "Nothing scheduled.", loading: "Loading Schedule...",
                now: "NOW", lunch: "Lunch Break", freelance: "Freelance / Self Study", today: "Today", tomorrow: "Tomorrow",
                yesterday: "Yesterday", dateNotFound: "Date not found in English section.", weekendTitle: "Weekend Vibes",
                freelanceTitle: "Self-Study Day", holidayTitle: "Semester Break", newYearTitle: "Happy New Year!",
                eidTitle: "Eid Mubarak!", logoText: "P1", badgeLab: "LAB", badgeClinical: "SKILLS", fetchError: "Could not auto-load 'schedule.xlsx'."
            },
            TR: {
                title: "DÃ¶nem I", subtitle: "AYBÃœ TÄ±p FakÃ¼ltesi", loadTitle: "HoÅŸ Geldiniz", loadDesc: "Ders programÄ±nÄ± yÃ¼kleyin.",
                selectFile: "Dosya GÃ¶zat", emptyTitle: "Ders BulunamadÄ±", emptyDesc: "Ders yok.", loading: "YÃ¼kleniyor...",
                now: "ÅžU AN", lunch: "Ã–ÄŸle ArasÄ±", freelance: "Bireysel Ã‡alÄ±ÅŸma", today: "BugÃ¼n", tomorrow: "YarÄ±n",
                yesterday: "DÃ¼n", dateNotFound: "TÃ¼rkÃ§e bÃ¶lÃ¼mÃ¼nde tarih bulunamadÄ±.", weekendTitle: "Hafta Sonu Modu",
                freelanceTitle: "Bireysel Ã‡alÄ±ÅŸma GÃ¼nÃ¼", holidayTitle: "Ä°yi Tatiller!", newYearTitle: "Mutlu YÄ±llar!",
                eidTitle: "Ä°yi Bayramlar!", logoText: "D1", badgeLab: "LAB", badgeClinical: "BECERÄ°", fetchError: "'schedule.xlsx' bulunamadÄ±."
            }
        };

        const WEEKEND_MESSAGES = { EN: ["It's the weekend! Time to recharge ðŸ”‹", "No classes today. Go touch some grass ðŸŒ±"], TR: ["Hafta sonu geldi! Åžarj olma zamanÄ± ðŸ”‹", "BugÃ¼n ders yok. Ã‡imlere basma vakti ðŸŒ±"] };
        const FREELANCE_MESSAGES = { EN: ["Focus mode: ON. You got this! ðŸ’¡", "Library day? Or coffee shop? â˜•"], TR: ["Odaklanma modu: AÃ‡IK. Yapabilirsin! ðŸ’¡", "KÃ¼tÃ¼phane mi, kahve dÃ¼kkanÄ± mÄ±? â˜•"] };
        const HOLIDAY_MESSAGES = { EN: ["Enjoy your holidays! âœˆï¸"], TR: ["Tatilin tadÄ±nÄ± Ã§Ä±kar! âœˆï¸"] };
        const NEW_YEAR_MESSAGES = { EN: ["Happy New Year! ðŸŽ‰"], TR: ["Mutlu YÄ±llar! ðŸŽ‰"] };
        const EID_MESSAGES = { EN: ["Eid Mubarak! ðŸ¬"], TR: ["Ä°yi Bayramlar! ðŸ¬"] };

        const HOLIDAY_KEYWORDS = ["holiday", "tatil", "sÃ¶mestr", "semester", "yarÄ±yÄ±l", "break", "resmi"];
        const NEW_YEAR_KEYWORDS = ["yÄ±lbaÅŸÄ±", "yilbasi", "new year", "noel", "happy new year", "yeni yÄ±l", "yeniyÄ±l", "yeni yil"];
        const EID_KEYWORDS = ["ramazan", "ramadan", "eid", "bayram", "kurban", "seker", "ÅŸeker"];
        const CLINICAL_KEYWORDS = ["clinical skills", "clinical skill", "klinik beceri", "cst", "beceri eÄŸitimi"];

        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem(STORAGE_KEY_LANG);
            if (savedLang) setLanguage(savedLang, false);
            else setLanguage('EN', false);

            const now = new Date();
            document.getElementById('datePicker').value = getLocalDateString(now);
            updateDateDisplay(now);
            updateDayProgress();

            document.getElementById('datePicker').addEventListener('change', (e) => {
                const parts = e.target.value.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]); 
                updateDateDisplay(d);
                if (workbookData) processSchedule(e.target.value); 
            });

            document.getElementById('fileInput').addEventListener('change', handleUpload);
            setInterval(updateDayProgress, 60000); 
            initApp();
        });

        async function initApp() {
            setLoading(true);
            const cachedData = localStorage.getItem(STORAGE_KEY_DATA);
            if(cachedData) {
                try {
                    workbookData = JSON.parse(cachedData);
                    setLoading(false);
                    processSchedule(document.getElementById('datePicker').value);
                    document.getElementById('resetBtn').classList.remove('hidden');
                    return; 
                } catch(e) {}
            }
            try {
                const response = await fetch(SCHEDULE_FILENAME);
                if (!response.ok) throw new Error("Auto-fetch failed");
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                workbookData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                try { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(workbookData)); } catch (err) {}
                setLoading(false);
                processSchedule(document.getElementById('datePicker').value);
                document.getElementById('resetBtn').classList.remove('hidden');
            } catch (err) {
                setLoading(false);
                document.getElementById('uploadSection').classList.remove('hidden');
                document.getElementById('fetch-error-msg').classList.remove('hidden');
                document.getElementById('fetch-error-msg').textContent = TRANSLATIONS[currentLang].fetchError;
            }
        }

        function updateDayProgress() {
            const now = new Date();
            const start = new Date(now); start.setHours(8, 30, 0); 
            const end = new Date(now); end.setHours(17, 30, 0);   
            const total = end - start;
            const current = now - start;
            let percent = 0;
            if (now < start) percent = 0;
            else if (now > end) percent = 100;
            else percent = (current / total) * 100;
            document.getElementById('dayProgressBar').style.width = `${percent}%`;
        }

        function vibrate() {
            if (navigator.vibrate) navigator.vibrate(5);
        }

        window.changeDay = function(offset) {
            vibrate();
            const picker = document.getElementById('datePicker');
            const currentVal = picker.value;
            if (!currentVal) return;

            const parts = currentVal.split('-');
            const currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
            
            do {
                currentDate.setDate(currentDate.getDate() + offset);
            } while (currentDate.getDay() === 0 || currentDate.getDay() === 6); 
            
            const newDateStr = getLocalDateString(currentDate);
            picker.value = newDateStr;
            updateDateDisplay(currentDate);
            
            const container = document.getElementById('scheduleContainer');
            container.classList.remove('anim-slide-left', 'anim-slide-right', 'card-enter');
            void container.offsetWidth; 

            if (workbookData) {
                processSchedule(newDateStr);
                container.classList.add(offset > 0 ? 'anim-slide-right' : 'anim-slide-left');
            }
        }

        window.setLanguage = function(lang, shouldProcess = true) {
            vibrate();
            currentLang = lang;
            localStorage.setItem(STORAGE_KEY_LANG, lang);
            document.getElementById('btn-tr').className = `toggle-btn btn-press px-3 py-1.5 text-[10px] font-bold rounded-md ${lang === 'TR' ? 'active' : 'inactive'}`;
            document.getElementById('btn-en').className = `toggle-btn btn-press px-3 py-1.5 text-[10px] font-bold rounded-md ${lang === 'EN' ? 'active' : 'inactive'}`;
            const t = TRANSLATIONS[lang];
            document.getElementById('txt-title').textContent = t.title;
            document.getElementById('txt-subtitle').textContent = t.subtitle;
            document.getElementById('txt-load-title').textContent = t.loadTitle;
            document.getElementById('txt-load-desc').textContent = t.loadDesc;
            document.getElementById('txt-select-file').textContent = t.selectFile;
            document.getElementById('phase-icon').textContent = t.logoText;
            document.getElementById('txt-loading').textContent = t.loading;
            if(!document.getElementById('fetch-error-msg').classList.contains('hidden')) {
                document.getElementById('fetch-error-msg').textContent = t.fetchError;
            }
            const pickerDate = document.getElementById('datePicker').value;
            if(pickerDate) {
                const parts = pickerDate.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]);
                updateDateDisplay(d);
            }
            if (shouldProcess && workbookData) processSchedule(document.getElementById('datePicker').value);
        }

        function getLocalDateString(dateObj) {
            if (!dateObj) return "";
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- FIXED DATE PARSING (12H Buffer) ---
        function normalizeDate(cellVal) {
            if (!cellVal) return null;
            if (cellVal instanceof Date) {
                // Add 12 hours to safely move out of "midnight" danger zones
                const safeDate = new Date(cellVal.getTime() + (12 * 60 * 60 * 1000));
                const year = safeDate.getUTCFullYear();
                const month = String(safeDate.getUTCMonth() + 1).padStart(2, '0');
                const day = String(safeDate.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            if (typeof cellVal === 'string') {
                const s = cellVal.trim();
                if (s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;
                if (s.match(/^\d{4}-\d{2}-\d{2}T/)) return s.split('T')[0];
            }
            return null;
        }

        function updateDateDisplay(dateObj) {
            const today = new Date();
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
            const dStr = dateObj.toDateString();
            const locale = currentLang === 'TR' ? 'tr-TR' : 'en-US';
            const datePart = dateObj.toLocaleDateString(locale, { weekday: 'short', month: 'short', day: 'numeric' });
            let label = null;
            if (dStr === today.toDateString()) label = TRANSLATIONS[currentLang].today;
            else if (dStr === tomorrow.toDateString()) label = TRANSLATIONS[currentLang].tomorrow;
            else if (dStr === yesterday.toDateString()) label = TRANSLATIONS[currentLang].yesterday;
            const displayEl = document.getElementById('dateDisplay');
            if (label) {
                displayEl.innerHTML = `<div class="flex flex-col items-center leading-none"><span class="text-[9px] text-blue-400 font-bold uppercase tracking-widest mb-0.5">${label}</span><span class="text-sm font-bold text-slate-800">${datePart}</span></div>`;
            } else {
                displayEl.innerHTML = `<span class="text-sm font-bold text-slate-700">${datePart}</span>`;
            }
        }

        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            vibrate();
            setLoading(true);
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                workbookData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                try { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(workbookData)); } catch (err) {}
                setLoading(false);
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('resetBtn').classList.remove('hidden');
                processSchedule(document.getElementById('datePicker').value);
            };
            reader.readAsArrayBuffer(file);
        }

        function isRowBarrier(row) {
            if (!row || !Array.isArray(row)) return false;
            for (let i = 0; i < row.length; i++) {
                const val = row[i];
                if (!val) continue;
                const dateStr = normalizeDate(val);
                if (dateStr && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) return true;
                if (typeof val === 'string') {
                    const s = val.toLowerCase().trim();
                    if (s.includes("committee chairman")) return true;
                    if (s.includes("komite sorumlularÄ±")) return true;
                    if (s.match(/^week\s*\d+$/)) return true; 
                    if (s.match(/^\d+\s*week$/)) return true;
                    if (s.match(/^hafta\s*\d+$/)) return true; 
                    if (s.match(/^\d+\s*hafta$/)) return true;
                    if (s.match(/^\d+\.\s*hafta$/)) return true;
                }
            }
            return false;
        }

        function isGarbageContent(val) {
            if (!val) return false;
            const s = String(val).trim();
            if (s.includes("GMT")) return true;
            if (s.startsWith("(Thu") || s.startsWith("(Mon") || s.startsWith("(Tue") || s.startsWith("(Wed") || s.startsWith("(Fri")) return true;
            if (s.match(/^\d+$/)) return true; 
            return false;
        }

        function showEmptyState(title, messages, iconHtml) {
            const emptyState = document.getElementById('emptyState');
            emptyState.classList.remove('hidden');
            document.getElementById('txt-empty-title').textContent = title;
            document.getElementById('emptyIcon').innerHTML = iconHtml;
            let msgText = Array.isArray(messages) ? messages[Math.floor(Math.random() * messages.length)] : messages;
            document.getElementById('txt-empty-desc').textContent = msgText;
        }

        function processSchedule(targetDateString) {
            if (!workbookData) return;
            const container = document.getElementById('scheduleContainer');
            const emptyState = document.getElementById('emptyState');
            container.innerHTML = '';
            container.classList.add('hidden');
            emptyState.classList.add('hidden');

            const parts = targetDateString.split('-');
            const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            const dayOfWeek = dateObj.getDay(); 
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                showEmptyState(TRANSLATIONS[currentLang].weekendTitle, WEEKEND_MESSAGES[currentLang], '<i class="fas fa-couch text-amber-300"></i>');
                return;
            }

            document.getElementById('emptyIcon').innerHTML = '<i class="fas fa-calendar-times"></i>';
            document.getElementById('txt-empty-title').textContent = TRANSLATIONS[currentLang].emptyTitle;

            let dateRowIndex = -1;
            let targetColIndex = -1;
            const isEnglish = currentLang === 'EN';
            const splitColumn = 8; 

            outerLoop:
            for (let r = 0; r < workbookData.length; r++) {
                const row = workbookData[r];
                for (let c = 0; c < row.length; c++) {
                    const normalized = normalizeDate(row[c]);
                    if (normalized === targetDateString) {
                        if ((isEnglish && c > splitColumn) || (!isEnglish && c <= splitColumn)) {
                            dateRowIndex = r;
                            targetColIndex = c;
                            break outerLoop;
                        }
                    }
                }
            }

            if (dateRowIndex === -1) {
                showEmptyState("No Classes Found", [TRANSLATIONS[currentLang].dateNotFound], '<i class="fas fa-calendar-times"></i>');
                return;
            }

            let timeColIndex = -1;
            for(let offset = 1; offset <= 4; offset++) {
                const checkRow = workbookData[dateRowIndex + offset];
                if(checkRow) {
                    for (let c = targetColIndex - 1; c >= 0; c--) {
                        const val = String(checkRow[c] || "");
                        if (val.match(/^\d{1,2}[:.]\d{2}/)) { timeColIndex = c; break; }
                    }
                }
                if (timeColIndex !== -1) break;
            }
            if (timeColIndex === -1) timeColIndex = isEnglish ? 9 : 0; 

            const classes = [];
            let r = dateRowIndex + 1;
            const maxRows = Math.min(workbookData.length, dateRowIndex + 100); 

            while (r < maxRows) {
                const row = workbookData[r];
                if (isRowBarrier(row)) break;

                const timeVal = timeColIndex !== -1 ? String(row[timeColIndex]).trim() : "";
                const timeMatch = timeVal.match(/(\d{1,2})[:.](\d{2})/);
                
                if (timeMatch) {
                    let timeSlot = `${timeMatch[1]}:${timeMatch[2]}`;
                    const hour = parseInt(timeMatch[1]);
                    const isLunchTime = (hour === 12 || hour === 13);
                    let contentLines = [];
                    const addLine = (val) => {
                        const s = String(val || "").trim();
                        if (!s || s === "undefined" || s.length < 3) return;
                        if (isGarbageContent(val)) return;
                        if (!contentLines.includes(s)) contentLines.push(s);
                    };
                    addLine(row[targetColIndex]);
                    let subR = r + 1;
                    while (subR < maxRows) {
                        const subRow = workbookData[subR];
                        if (isRowBarrier(subRow)) break; 
                        const nextTime = String(subRow[timeColIndex] || "").trim();
                        if (nextTime.match(/\d{1,2}[:.]\d{2}/)) break; 
                        addLine(subRow[targetColIndex]);
                        subR++;
                    }
                    r = subR - 1;

                    if (contentLines.length > 0) {
                        const rawJoined = contentLines.join(" ");
                        const joinedLower = rawJoined.toLocaleLowerCase('tr-TR');
                        const joinedUpper = rawJoined.toUpperCase();
                        
                        const isNewYear = NEW_YEAR_KEYWORDS.some(kw => joinedLower.includes(kw));
                        const isEid = EID_KEYWORDS.some(kw => joinedLower.includes(kw));
                        const isHoliday = HOLIDAY_KEYWORDS.some(kw => joinedLower.includes(kw));
                        
                        let isLab = joinedUpper.includes("LAB");
                        if (joinedLower.includes("inkÄ±lab") || joinedLower.includes("inkilap") || joinedLower.includes("history")) {
                            isLab = false;
                        }
                        const isClinical = CLINICAL_KEYWORDS.some(kw => joinedLower.includes(kw));
                        const isFreelance = joinedLower.includes("freelance") || joinedLower.includes("bireysel");
                        const isLunchText = joinedLower.includes("lunch") || joinedLower.includes("Ã¶ÄŸle arasÄ±");
                        
                        if (isNewYear) classes.push({ time: timeSlot, lines: [rawJoined], type: 'new_year_item' });
                        else if (isEid) classes.push({ time: timeSlot, lines: [rawJoined], type: 'eid_item' });
                        else if (isHoliday) classes.push({ time: timeSlot, lines: [rawJoined], type: 'holiday_item' });
                        else if (isLunchText) classes.push({ time: timeSlot, lines: [TRANSLATIONS[currentLang].lunch], type: 'lunch' });
                        else if (isFreelance) classes.push({ time: timeSlot, lines: [TRANSLATIONS[currentLang].freelance], type: 'freelance' });
                        else classes.push({ time: timeSlot, lines: contentLines, isLab: isLab, isClinical: isClinical });
                    } else if (isLunchTime) {
                        classes.push({ time: timeSlot, lines: [TRANSLATIONS[currentLang].lunch], type: 'lunch' });
                    }
                }
                r++;
            }

            const newYearItems = classes.filter(c => c.type === 'new_year_item');
            if (newYearItems.length > 0) { showEmptyState(TRANSLATIONS[currentLang].newYearTitle, NEW_YEAR_MESSAGES[currentLang], '<i class="fas fa-glass-cheers text-pink-400"></i>'); return; }
            const eidItems = classes.filter(c => c.type === 'eid_item');
            if (eidItems.length > 0) { showEmptyState(TRANSLATIONS[currentLang].eidTitle, EID_MESSAGES[currentLang], '<i class="fas fa-moon text-yellow-400"></i>'); return; }
            const holidayItems = classes.filter(c => c.type === 'holiday_item');
            if (holidayItems.length > 0) { showEmptyState(TRANSLATIONS[currentLang].holidayTitle, HOLIDAY_MESSAGES[currentLang], '<i class="fas fa-umbrella-beach text-cyan-400"></i>'); return; }

            const actualLessons = classes.filter(c => c.type !== 'lunch');
            if (actualLessons.length > 0 && actualLessons.every(c => c.type === 'freelance')) {
                showEmptyState(TRANSLATIONS[currentLang].freelanceTitle, FREELANCE_MESSAGES[currentLang], '<i class="fas fa-laptop-house text-indigo-400"></i>');
            } else {
                renderClasses(classes, targetDateString);
            }
        }

        function renderClasses(classes, targetDateStr) {
            const container = document.getElementById('scheduleContainer');
            if (classes.length === 0) {
                showEmptyState(TRANSLATIONS[currentLang].emptyTitle, [TRANSLATIONS[currentLang].emptyDesc], '<i class="fas fa-calendar-check"></i>');
                return;
            }
            container.classList.remove('hidden');
            const t = TRANSLATIONS[currentLang];
            classes.forEach((cls, index) => {
                const isNow = checkIsNow(cls.time, targetDateStr);
                const isLunch = cls.type === 'lunch';
                const isFreelance = cls.type === 'freelance';
                const isLast = index === classes.length - 1;
                const card = document.createElement('div');
                card.className = `relative flex gap-4 card-enter ${isLast ? 'last-item' : ''}`;
                card.style.animationDelay = `${index * 0.08}s`;
                
                let circleClass = "bg-white border-2 border-slate-200";
                let iconClass = "text-slate-300";
                let icon = "fa-clock";
                let cardBg = "bg-white border-slate-100 shadow-sm hover:border-blue-200";

                if (isNow) {
                    circleClass = "bg-blue-600 ring-4 ring-blue-100 scale-110 shadow-lg shadow-blue-200/50"; iconClass = "text-white"; cardBg = "glow-border shadow-lg transform scale-[1.02]";
                } else if (isLunch) {
                    circleClass = "bg-amber-100 border-2 border-amber-200"; iconClass = "text-amber-500"; icon = "fa-utensils"; cardBg = "bg-amber-50/50 border-amber-100 border-dashed";
                } else if (isFreelance) {
                    circleClass = "bg-slate-100 border-2 border-slate-300"; iconClass = "text-slate-400"; icon = "fa-book-reader"; cardBg = "bg-slate-50 border-slate-200 border-dashed opacity-80";
                } else if (cls.isLab) {
                    circleClass = "bg-rose-100 border-2 border-rose-200"; iconClass = "text-rose-500"; icon = "fa-flask"; cardBg = "bg-rose-50/50 border-rose-200 shadow-md border-l-4 border-l-rose-500";
                } else if (cls.isClinical) {
                    circleClass = "bg-violet-100 border-2 border-violet-200"; iconClass = "text-violet-500"; icon = "fa-stethoscope"; cardBg = "bg-violet-50/50 border-violet-200 shadow-md border-l-4 border-l-violet-500";
                }
                
                let linesHtml = '';
                cls.lines.forEach((line, idx) => {
                    if (isLunch) linesHtml += `<div class="font-bold text-amber-700/80 text-base leading-tight italic">${line}</div>`;
                    else if (isFreelance) linesHtml += `<div class="font-medium text-slate-500 italic text-base">${line}</div>`;
                    else {
                        if (idx === 0) linesHtml += `<div class="font-bold text-slate-800 text-lg leading-tight mb-1">${line}</div>`;
                        else if (idx === 1) linesHtml += `<div class="font-medium text-slate-600 text-sm leading-snug mb-2">${line}</div>`;
                        else linesHtml += `<div class="flex items-center gap-2 text-slate-400 text-xs mt-1"><i class="fas fa-user-circle"></i><span>${line}</span></div>`;
                    }
                });

                let badgeHtml = '';
                if (cls.isLab) badgeHtml = `<span class="bg-rose-100 text-rose-600 text-[10px] font-bold px-2 py-0.5 rounded border border-rose-200 ml-2">${t.badgeLab}</span>`;
                else if (cls.isClinical) badgeHtml = `<span class="bg-violet-100 text-violet-600 text-[10px] font-bold px-2 py-0.5 rounded border border-violet-200 ml-2">${t.badgeClinical}</span>`;
                if (isNow) badgeHtml += `<span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse shadow-sm shadow-blue-200 ml-2">${t.now}</span>`;

                card.innerHTML = `<div class="flex flex-col items-center"><div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 z-10 ${circleClass} transition-all duration-300"><i class="fas ${icon} ${iconClass} text-sm"></i></div><div class="time-connector"></div></div><div class="flex-1 pb-8 min-w-0"><div class="p-5 rounded-2xl border ${cardBg} transition-all duration-300"><div class="flex justify-between items-center mb-3"><div class="flex items-center"><span class="font-mono text-xs font-bold ${isNow ? 'text-blue-700 bg-blue-100' : (isLunch ? 'text-amber-600 bg-amber-100' : (isFreelance ? 'text-slate-500 bg-slate-200' : (cls.isLab ? 'text-rose-600 bg-rose-100' : (cls.isClinical ? 'text-violet-600 bg-violet-100' : 'text-slate-500 bg-slate-100'))))} px-2 py-1 rounded-lg">${cls.time}</span>${badgeHtml}</div></div><div>${linesHtml}</div></div></div>`;
                container.appendChild(card);
            });
            setTimeout(() => {
                const active = container.querySelector('.glow-border');
                if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            }, 600);
        }

        function checkIsNow(timeStr, targetDateStr) {
            const todayStr = getLocalDateString(new Date());
            if (targetDateStr !== todayStr) return false;
            try {
                const parts = timeStr.split(':');
                const h = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                const now = new Date();
                const curMins = now.getHours() * 60 + now.getMinutes();
                const startMins = h * 60 + m;
                let endMins = startMins + 50; 
                return curMins >= startMins && curMins < endMins;
            } catch(e) { return false; }
        }

        function setLoading(isLoading) {
            document.getElementById('loadingState').classList.toggle('hidden', !isLoading);
            if (isLoading) document.getElementById('uploadSection').classList.add('hidden');
        }
    </script>
</body>
</html>


