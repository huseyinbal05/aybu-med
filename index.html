<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300 overflow-x-hidden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AYBU Schedule</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AYBU Sched">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/833/833593.png">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'modal-pop': 'modalFadeIn 0.3s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            'from': { opacity: '0', transform: 'translateY(15px) scale(0.98)' },
                            'to': { opacity: '1', transform: 'translateY(0) scale(1)' }
                        },
                        modalFadeIn: {
                            'from': { opacity: '0', transform: 'scale(0.95)' },
                            'to': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Heavy Libs -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js" defer></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        html, body { overflow-x: hidden; width: 100%; position: relative; -webkit-tap-highlight-color: transparent; }
        
        /* Hide scrollbar for horizontal strip but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glow-border { position: relative; z-index: 1; transition: transform 0.3s ease; }
        .glow-border::before {
            content: ""; position: absolute; inset: -2px; border-radius: 20px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 200%; animation: gradientMove 3s ease infinite; z-index: -1; opacity: 0.8;
        }
        @keyframes gradientMove { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }

        .time-connector { position: absolute; z-index: 0; }
        .mobile-connector { left: 23px; top: 45px; bottom: -20px; width: 2px; }
        .desktop-connector { display: none; }
        .last-item .time-connector { display: none; }
        @media (min-width: 768px) {
            .desktop-connector { left: 50%; transform: translateX(-50%); top: 3rem; bottom: -2rem; width: 2px; display: block; }
        }

        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); touch-action: manipulation; }
        .btn-press:active { transform: scale(0.92); }

        #searchContainer { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 0; overflow: hidden; opacity: 0; }
        #searchContainer.open { max-height: 80px; opacity: 1; margin-top: 0.5rem; }
    </style>
    
    <script>
        // Inline critical theme logic to prevent FOUC
        (function() {
            const savedTheme = localStorage.getItem('aybu_theme_v1');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen pb-6 transition-colors duration-300 flex flex-col font-sans">

    <!-- Install Banner -->
    <div id="installBanner" class="hidden bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 shadow-lg relative z-50 cursor-pointer border-b border-white/10" onclick="openInstallModal()">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm animate-pulse">
                    <i class="fas fa-download text-white text-xs"></i>
                </div>
                <div>
                    <span id="txt-install-banner-title" class="block font-bold text-xs">Install App</span>
                    <span id="txt-install-banner-desc" class="block text-[10px] text-indigo-100 opacity-90">Better performance & offline access</span>
                </div>
            </div>
            <button onclick="event.stopPropagation(); closeInstallBanner()" class="text-white/70 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border-b border-slate-200 dark:border-slate-800 shadow-sm transition-all duration-300 w-full">
        <div class="max-w-4xl mx-auto pt-3 pb-1 flex flex-col gap-3 w-full">
            
            <!-- Top Row: Branding & Actions -->
            <div class="flex items-center justify-between px-4">
                <div class="flex items-center gap-3 cursor-pointer" onclick="goToToday()">
                    <div id="phase-icon" class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-lg flex items-center justify-center text-white font-extrabold text-sm shadow-md shadow-blue-500/20">
                        D1
                    </div>
                    <div>
                        <h1 id="txt-title" class="font-bold text-sm text-slate-900 dark:text-white leading-tight">Phase I</h1>
                        <p id="txt-subtitle" class="text-[10px] text-slate-500 dark:text-slate-400 font-semibold tracking-wide uppercase">AYBU Medicine</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <!-- Language -->
                    <button onclick="toggleLanguage()" class="btn-press h-8 px-2 flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
                        <span id="lang-indicator" class="text-[10px] font-bold text-slate-600 dark:text-slate-300">EN</span>
                        <i class="fas fa-globe text-[10px] text-slate-400"></i>
                    </button>

                    <!-- Theme -->
                    <button onclick="toggleDarkMode()" class="btn-press w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 transition-colors">
                        <i id="darkModeIcon" class="fas fa-moon text-xs"></i>
                    </button>
                    
                    <!-- Search -->
                    <button onclick="toggleSearch()" id="searchBtn" class="btn-press w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 dark:bg-slate-800 text-blue-600 dark:text-blue-400 border border-blue-100 dark:border-slate-700">
                        <i class="fas fa-search text-xs"></i>
                    </button>
                    
                     <!-- Date Picker Trigger (Hidden input wrapper) -->
                    <div class="relative w-8 h-8">
                        <input aria-label="Date Picker" type="date" id="datePicker" class="opacity-0 absolute inset-0 w-full h-full z-20 cursor-pointer">
                        <button class="w-full h-full flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700 pointer-events-none">
                             <i class="far fa-calendar-alt text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div id="searchContainer" class="w-full px-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <input type="text" id="searchInput" placeholder="Search topics, rooms..." 
                           class="w-full pl-9 pr-9 py-2.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500/50 outline-none text-sm font-medium transition-all"
                           oninput="handleGlobalSearch(this.value)">
                    <button onclick="toggleSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xs"></i></button>
                </div>
            </div>
            
            <!-- Horizontal Date Strip -->
            <div id="dateStrip" class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1 px-4 scroll-smooth select-none w-full">
                <!-- Javascript will inject days here -->
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="h-[2px] w-full bg-slate-100 dark:bg-slate-800 relative">
            <div id="dayProgressBar" class="h-full bg-gradient-to-r from-blue-400 to-indigo-600 w-0 transition-[width] duration-1000 ease-linear shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
        </div>
    </header>

    <main class="w-full max-w-4xl mx-auto p-4 flex-1">
        <div id="scheduleContainer" class="hidden mt-2 relative pl-1 pb-10 md:pl-0 md:pb-0 min-h-[50vh]"></div>
        <div id="searchResultsContainer" class="hidden mt-2 space-y-3"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-20 px-6 animate-fade-in-up">
            <div id="emptyIcon" class="text-5xl text-slate-200 dark:text-slate-700 mb-4 scale-100 transition-transform duration-500 hover:scale-110 hover:rotate-6 inline-block"></div>
            <h3 id="txt-empty-title" class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-1"></h3>
            <p id="txt-empty-desc" class="text-slate-400 dark:text-slate-500 text-sm max-w-[260px] mx-auto"></p>
        </div>

        <!-- No Search Results -->
        <div id="noSearchResults" class="hidden text-center py-16 px-6">
             <div class="text-4xl text-slate-200 dark:text-slate-700 mb-3"><i class="fas fa-search"></i></div>
             <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">No matches found.</p>
        </div>

        <!-- Loading Skeleton -->
        <div id="loadingState" class="w-full mt-6 space-y-6 animate-pulse px-2">
            <!-- Repeater -->
            <div class="flex gap-4">
                <div class="w-12 pt-2 flex flex-col items-end gap-1">
                    <div class="h-3 w-8 bg-slate-200 dark:bg-slate-800 rounded"></div>
                    <div class="h-8 w-8 rounded-full bg-slate-200 dark:bg-slate-800"></div>
                </div>
                <div class="flex-1 h-24 bg-slate-100 dark:bg-slate-800/50 rounded-2xl border border-slate-200/50 dark:border-slate-700/50"></div>
            </div>
             <div class="flex gap-4">
                <div class="w-12 pt-2 flex flex-col items-end gap-1">
                    <div class="h-3 w-8 bg-slate-200 dark:bg-slate-800 rounded"></div>
                    <div class="h-8 w-8 rounded-full bg-slate-200 dark:bg-slate-800"></div>
                </div>
                <div class="flex-1 h-24 bg-slate-100 dark:bg-slate-800/50 rounded-2xl border border-slate-200/50 dark:border-slate-700/50"></div>
            </div>
             <div class="flex gap-4">
                <div class="w-12 pt-2 flex flex-col items-end gap-1">
                    <div class="h-3 w-8 bg-slate-200 dark:bg-slate-800 rounded"></div>
                    <div class="h-8 w-8 rounded-full bg-slate-200 dark:bg-slate-800"></div>
                </div>
                <div class="flex-1 h-24 bg-slate-100 dark:bg-slate-800/50 rounded-2xl border border-slate-200/50 dark:border-slate-700/50"></div>
            </div>
            <p id="txt-loading" class="text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase mt-8">Syncing Data...</p>
        </div>
    </main>
    
    <!-- Install Modal -->
    <div id="installModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-6 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-800 rounded-3xl max-w-xs w-full p-6 shadow-2xl animate-modal-pop relative border border-white/10">
            <button onclick="closeInstallModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"><i class="fas fa-times text-lg"></i></button>
            <div class="text-center mb-5">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl">ðŸš€</div>
                <h3 id="txt-install-title" class="text-lg font-bold text-slate-800 dark:text-white">Install App</h3>
            </div>
            <div class="space-y-3">
                <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
                    <i class="fab fa-apple text-2xl text-slate-800 dark:text-slate-200"></i>
                    <div class="text-xs text-slate-600 dark:text-slate-300">Tap <span class="font-bold">Share</span> <i class='fas fa-share-square'></i> then <span class="font-bold">Add to Home Screen</span></div>
                </div>
                 <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700">
                    <i class="fab fa-android text-2xl text-green-500"></i>
                    <div class="text-xs text-slate-600 dark:text-slate-300">Tap <span class="font-bold">Menu</span> <i class='fas fa-ellipsis-v'></i> then <span class="font-bold">Install App</span></div>
                </div>
            </div>
            <button onclick="closeInstallModal()" class="mt-5 w-full bg-slate-900 dark:bg-blue-600 hover:opacity-90 text-white font-bold py-3 rounded-xl text-sm transition-all shadow-lg" id="txt-install-close">Got it</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full text-center py-6">
        <div class="text-[10px] font-bold text-slate-300 dark:text-slate-700 uppercase tracking-widest mb-2">AYBU Medicine â€¢ v2.7 Final</div>
        <button onclick="hardReset()" class="text-[9px] text-slate-300 hover:text-rose-400 dark:text-slate-600 dark:hover:text-rose-400 underline transition-colors">Reset Data</button>
    </footer>

    <!-- Floating Today Button -->
    <button id="todayBtn" onclick="goToToday()" class="hidden fixed bottom-6 right-6 md:bottom-10 md:right-10 w-12 h-12 bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 rounded-2xl shadow-xl shadow-blue-900/10 border border-blue-50 dark:border-slate-600 flex items-center justify-center z-40 btn-press transition-all hover:bg-blue-50 dark:hover:bg-slate-600 group">
        <i class="fas fa-calendar-day text-lg group-hover:scale-110 transition-transform"></i>
    </button>

    <script>
        // --- CONFIG & CONSTANTS ---
        const CONFIG = {
            SCHEDULE_FILENAME: 'schedule.xlsx',
            SPLIT_COLUMN_INDEX: 8, 
            STORAGE_KEYS: { DATA: 'aybu_data_v48', LANG: 'aybu_lang_v48', THEME: 'aybu_theme_v1' }
        };

        const CONSTANTS = {
            HOLIDAYS: ["holiday", "tatil", "sÃ¶mestr", "semester", "yarÄ±yÄ±l", "break", "resmi", "ara tatil", "ulusal", "cumhuriyet", "zafer", "emek", "demokrasi"],
            NEW_YEAR: ["yÄ±lbaÅŸÄ±", "yilbasi", "new year", "noel", "happy new year", "yeni yÄ±l", "yeniyÄ±l", "yeni yil"],
            EID: ["ramazan", "ramadan", "eid", "bayram", "kurban", "seker", "ÅŸeker"],
            CLINICAL: ["clinical skills", "clinical skill", "klinik beceri", "cst", "beceri eÄŸitimi"],
            LAB_EXCLUDES: ["inkÄ±lab", "history"]
        };

        const PALETTE = [
            { bg: 'bg-blue-50 dark:bg-blue-900/20', text: 'text-blue-700 dark:text-blue-300', border: 'border-blue-200 dark:border-blue-800' },
            { bg: 'bg-emerald-50 dark:bg-emerald-900/20', text: 'text-emerald-700 dark:text-emerald-300', border: 'border-emerald-200 dark:border-emerald-800' },
            { bg: 'bg-amber-50 dark:bg-amber-900/20', text: 'text-amber-700 dark:text-amber-300', border: 'border-amber-200 dark:border-amber-800' },
            { bg: 'bg-purple-50 dark:bg-purple-900/20', text: 'text-purple-700 dark:text-purple-300', border: 'border-purple-200 dark:border-purple-800' },
            { bg: 'bg-rose-50 dark:bg-rose-900/20', text: 'text-rose-700 dark:text-rose-300', border: 'border-rose-200 dark:border-rose-800' },
            { bg: 'bg-cyan-50 dark:bg-cyan-900/20', text: 'text-cyan-700 dark:text-cyan-300', border: 'border-cyan-200 dark:border-cyan-800' },
            { bg: 'bg-indigo-50 dark:bg-indigo-900/20', text: 'text-indigo-700 dark:text-indigo-300', border: 'border-indigo-200 dark:border-indigo-800' },
            { bg: 'bg-teal-50 dark:bg-teal-900/20', text: 'text-teal-700 dark:text-teal-300', border: 'border-teal-200 dark:border-teal-800' },
        ];

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            EN: {
                title: "Phase I", subtitle: "AYBU Medicine",
                emptyTitle: "Nothing Here", emptyDesc: "Relax, no classes scheduled for this day.", loading: "Syncing Data...",
                now: "NOW", lunch: "Lunch Break", freelance: "Self Study", today: "Today", tomorrow: "Tomorrow",
                yesterday: "Yesterday", badgeLab: "LAB", badgeClinical: "SKILLS", 
                installBannerTitle: "Install App", installBannerDesc: "Faster loading & offline access",
                weekendTitle: "Weekend Vibes", freelanceTitle: "Study Day", holidayTitle: "Holiday",
                endsIn: "Ends in", startsIn: "Starts in"
            },
            TR: {
                title: "DÃ¶nem I", subtitle: "AYBÃœ TÄ±p",
                emptyTitle: "Ders Yok", emptyDesc: "BugÃ¼n programÄ±n boÅŸ. Dinlenebilirsin.", loading: "YÃ¼kleniyor...",
                now: "ÅžU AN", lunch: "Ã–ÄŸle ArasÄ±", freelance: "Bireysel Ã‡alÄ±ÅŸma", today: "BugÃ¼n", tomorrow: "YarÄ±n",
                yesterday: "DÃ¼n", badgeLab: "LAB", badgeClinical: "BECERÄ°",
                installBannerTitle: "UygulamayÄ± YÃ¼kle", installBannerDesc: "Ã‡evrimdÄ±ÅŸÄ± ve hÄ±zlÄ± eriÅŸim",
                weekendTitle: "Hafta Sonu", freelanceTitle: "Ã‡alÄ±ÅŸma GÃ¼nÃ¼", holidayTitle: "Tatil",
                endsIn: "BitiÅŸ:", startsIn: "BaÅŸlangÄ±Ã§:"
            }
        };

        const MESSAGES = {
            WEEKEND: { EN: ["Recharge batteries ðŸ”‹", "Go touch grass ðŸŒ±"], TR: ["Pilleri ÅŸarj et ðŸ”‹", "Ã‡imlere basma vakti ðŸŒ±"] },
            FREELANCE: { EN: ["Library or Cafe? â˜•", "Focus mode: ON ðŸ’¡"], TR: ["KÃ¼tÃ¼phane mi, Kafe mi? â˜•", "Odaklanma modu: AÃ‡IK ðŸ’¡"] },
        };

        // --- STATE ---
        let workbookData = null;
        let searchIndexes = { EN: [], TR: [] }; 
        let currentLang = 'EN';
        let viewMode = 'day';

        // --- UTILS ---
        const DateUtils = {
            normalize: (cellVal) => {
                if (!cellVal) return null;
                if (cellVal instanceof Date) {
                    const safe = new Date(cellVal.getTime() + (12 * 60 * 60 * 1000));
                    return safe.toISOString().split('T')[0];
                }
                if (typeof cellVal === 'string') {
                    const s = cellVal.trim();
                    if (s.match(/^\d{4}-\d{2}-\d{2}$/)) return s; 
                    if (s.match(/^\d{4}-\d{2}-\d{2}T/)) return s.split('T')[0]; 
                }
                return null;
            },
            parse: (dateStr) => {
                if (!dateStr) return null;
                const parts = dateStr.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]);
            },
            getTodayString: () => {
                const now = new Date();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                return `${now.getFullYear()}-${m}-${d}`;
            }
        };

        function getSubjectColor(subjectName) {
            let hash = 0;
            for (let i = 0; i < subjectName.length; i++) {
                hash = subjectName.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % PALETTE.length;
            return PALETTE[index];
        }

        const ClassTypeDetector = {
            detect: (rawText) => {
                const lower = rawText.toLocaleLowerCase('tr-TR');
                let isLab = rawText.toUpperCase().includes("LAB") && !CONSTANTS.LAB_EXCLUDES.some(ex => lower.includes(ex));
                const isClinical = CONSTANTS.CLINICAL.some(kw => lower.includes(kw));
                const isFreelance = lower.includes("freelance") || lower.includes("bireysel");
                const isLunch = lower.includes("lunch") || lower.includes("Ã¶ÄŸle arasÄ±");
                
                let type = 'normal';
                if (CONSTANTS.NEW_YEAR.some(kw => lower.includes(kw))) type = 'new_year_item';
                else if (CONSTANTS.EID.some(kw => lower.includes(kw))) type = 'eid_item';
                else if (CONSTANTS.HOLIDAYS.some(kw => lower.includes(kw))) type = 'holiday_item';
                else if (isLunch) type = 'lunch';
                else if (isFreelance) type = 'freelance';

                return { type, isLab, isClinical };
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); initLang(); initDate();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }

            setInterval(updateDayProgress, 60000); 
            setInterval(updateNowBadgeTimer, 60000);
            initApp();
            checkInstallBanner();
        });

        // --- APP CORE ---
        async function initApp() {
            setLoading(true);
            
            try {
                const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.DATA);
                if(stored) {
                    workbookData = JSON.parse(stored);
                    refreshView(); 
                    setLoading(false);
                    setTimeout(() => buildSearchIndexes(), 100);
                }
            } catch(e) { console.error(e); }

            try {
                const res = await fetch(CONFIG.SCHEDULE_FILENAME + '?v=' + Date.now());
                if (!res.ok) throw new Error("Net fail");
                
                const buf = await res.arrayBuffer();
                await new Promise(r => window.XLSX ? r() : document.querySelector('script[src*="xlsx"]').onload = r);

                const wb = XLSX.read(buf, { type: 'array', cellDates: true });
                const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: "" });
                
                const freshData = rawData.map(row => row.map(cell => {
                    return (cell instanceof Date) ? DateUtils.normalize(cell) : cell;
                }));

                const jsonFresh = JSON.stringify(freshData);
                if (localStorage.getItem(CONFIG.STORAGE_KEYS.DATA) !== jsonFresh) {
                    workbookData = freshData;
                    localStorage.setItem(CONFIG.STORAGE_KEYS.DATA, jsonFresh);
                    refreshView();
                    buildSearchIndexes();
                }
            } catch (err) {
                console.warn("Using Mock Data");
                if(!workbookData) {
                    workbookData = generateMockData();
                    refreshView();
                }
            }
            setLoading(false);
            document.getElementById('todayBtn').classList.remove('hidden');
        }

        // --- UI LOGIC ---

        function initTheme() {
            const apply = () => {
                const s = localStorage.getItem(CONFIG.STORAGE_KEYS.THEME);
                const d = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.classList.toggle('dark', s === 'dark' || (!s && d));
                document.getElementById('darkModeIcon').className = document.documentElement.classList.contains('dark') ? 'fas fa-moon text-xs' : 'fas fa-sun text-xs text-yellow-600';
            };
            apply();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => !localStorage.getItem(CONFIG.STORAGE_KEYS.THEME) && apply());
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem(CONFIG.STORAGE_KEYS.THEME, isDark ? 'light' : 'dark');
            document.documentElement.classList.toggle('dark', !isDark);
            document.getElementById('darkModeIcon').className = !isDark ? 'fas fa-moon text-xs' : 'fas fa-sun text-xs text-yellow-600';
        }

        function initLang() {
            const s = localStorage.getItem(CONFIG.STORAGE_KEYS.LANG) || 'EN';
            setLanguage(s, false);
        }

        function toggleLanguage() {
            const n = currentLang === 'EN' ? 'TR' : 'EN';
            setLanguage(n);
        }

        function setLanguage(lang, refresh = true) {
            currentLang = lang;
            localStorage.setItem(CONFIG.STORAGE_KEYS.LANG, lang);
            document.getElementById('lang-indicator').textContent = lang;
            
            const t = TRANSLATIONS[lang];
            ['txt-title', 'txt-subtitle', 'txt-loading', 'txt-install-banner-title', 'txt-install-banner-desc', 'txt-install-title', 'txt-install-close'].forEach(id => {
                const el = document.getElementById(id);
                const k = id.replace('txt-','').replace(/-([a-z])/g, g => g[1].toUpperCase());
                if(el && t[k]) el.textContent = t[k];
            });

            document.getElementById('phase-icon').textContent = lang === 'EN' ? 'P1' : 'D1';
            
            if (refresh && workbookData) {
                renderDateStrip(); // Re-render strip for day names
                refreshView();
            }
        }

        function initDate() {
            const today = DateUtils.getTodayString();
            document.getElementById('datePicker').value = today;
            document.getElementById('datePicker').addEventListener('change', (e) => {
                renderDateStrip();
                refreshView();
            });
            renderDateStrip();
            updateDayProgress();
        }

        // --- NEW COMPONENT: DATE STRIP ---
        function renderDateStrip() {
            const strip = document.getElementById('dateStrip');
            strip.innerHTML = '';
            
            const pickerVal = document.getElementById('datePicker').value;
            const current = DateUtils.parse(pickerVal);
            
            // Generate range: 3 days before -> 3 days after
            const start = new Date(current);
            start.setDate(current.getDate() - 2); // Show a bit of context
            
            const locale = currentLang === 'TR' ? 'tr-TR' : 'en-US';

            for(let i=0; i<6; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const dStr = DateUtils.normalize(d);
                const isSelected = dStr === pickerVal;
                const isToday = dStr === DateUtils.getTodayString();
                
                const dayName = d.toLocaleDateString(locale, { weekday: 'short' }).toUpperCase();
                const dayNum = d.getDate();

                // Style Logic
                let btnClass = "flex-none flex flex-col items-center justify-center w-[50px] h-[58px] rounded-xl border transition-all cursor-pointer select-none active:scale-95";
                let textClass = "";
                let numClass = "text-lg font-bold leading-none mt-0.5";

                if (isSelected) {
                    btnClass += " bg-blue-600 border-blue-600 shadow-md shadow-blue-300 dark:shadow-blue-900/50";
                    textClass = "text-[9px] font-bold text-blue-100";
                    numClass += " text-white";
                } else if (isToday) {
                    btnClass += " bg-white dark:bg-slate-800 border-blue-400 dark:border-blue-500";
                    textClass = "text-[9px] font-bold text-blue-600 dark:text-blue-400";
                    numClass += " text-blue-600 dark:text-blue-400";
                } else {
                    btnClass += " bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600";
                    textClass = "text-[9px] font-bold text-slate-400";
                    numClass += " text-slate-700 dark:text-slate-300";
                }

                const el = document.createElement('div');
                el.className = btnClass;
                el.onclick = () => {
                    document.getElementById('datePicker').value = dStr;
                    renderDateStrip(); // Re-render to update active state
                    refreshView();
                };
                el.innerHTML = `<span class="${textClass}">${dayName}</span><span class="${numClass}">${dayNum}</span>`;
                strip.appendChild(el);
            }
        }

        // --- CORE LOGIC ---

        function refreshView() {
            const dateStr = document.getElementById('datePicker').value;
            if(!workbookData) return;
            
            document.getElementById('searchResultsContainer').classList.add('hidden');
            document.getElementById('noSearchResults').classList.add('hidden');
            document.getElementById('scheduleContainer').classList.remove('hidden');
            
            processSchedule(dateStr);
        }

        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            const input = document.getElementById('searchInput');
            container.classList.toggle('open');
            
            if(container.classList.contains('open')) {
                input.focus();
                viewMode = 'search';
                document.getElementById('scheduleContainer').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('dateStrip').classList.add('opacity-50', 'pointer-events-none');
                handleGlobalSearch(input.value);
            } else {
                input.value = '';
                viewMode = 'day';
                document.getElementById('searchResultsContainer').innerHTML = '';
                document.getElementById('searchResultsContainer').classList.add('hidden');
                document.getElementById('noSearchResults').classList.add('hidden');
                document.getElementById('dateStrip').classList.remove('opacity-50', 'pointer-events-none');
                input.blur();
                refreshView();
            }
        }

        function processSchedule(dateStr) {
            const container = document.getElementById('scheduleContainer');
            const emptyState = document.getElementById('emptyState');
            container.innerHTML = '';
            emptyState.classList.add('hidden');

            const dateObj = DateUtils.parse(dateStr);
            if (dateObj.getDay() === 0 || dateObj.getDay() === 6) {
                showEmptyState(TRANSLATIONS[currentLang].weekendTitle, MESSAGES.WEEKEND[currentLang], '<i class="fas fa-couch text-amber-300"></i>');
                return;
            }

            const classes = getClassesForDate(dateStr);

            if (classes.length === 0) {
                 showEmptyState(TRANSLATIONS[currentLang].emptyTitle, TRANSLATIONS[currentLang].emptyDesc, '<i class="fas fa-mug-hot text-slate-300"></i>');
                 return;
            }

            // Check special types
            const special = classes.find(c => ['new_year_item', 'eid_item', 'holiday_item'].includes(c.type));
            if(special) {
                let icon = '<i class="fas fa-calendar-check"></i>';
                let title = TRANSLATIONS[currentLang].holidayTitle;
                if(special.type === 'new_year_item') icon = '<i class="fas fa-glass-cheers text-pink-400"></i>';
                if(special.type === 'eid_item') icon = '<i class="fas fa-moon text-yellow-400"></i>';
                showEmptyState(title, special.lines[0], icon);
                return;
            }
            
            if (classes.every(c => c.type === 'freelance')) {
                showEmptyState(TRANSLATIONS[currentLang].freelanceTitle, MESSAGES.FREELANCE[currentLang], '<i class="fas fa-laptop-code text-indigo-400"></i>');
            } else {
                renderClasses(classes, dateStr);
            }
        }

        function renderClasses(classes, targetDateStr) {
            const container = document.getElementById('scheduleContainer');
            const t = TRANSLATIONS[currentLang];
            const fragment = document.createDocumentFragment();
            let hasActiveNow = false;

            // First pass to check if any class is active
            if(targetDateStr === DateUtils.getTodayString()) {
                hasActiveNow = classes.some(c => checkIsNow(c.time, targetDateStr));
            }

            classes.forEach((cls, index) => {
                const isNow = checkIsNow(cls.time, targetDateStr);
                const isLunch = cls.type === 'lunch';
                const isLast = index === classes.length - 1;
                
                // Color Logic
                let theme = { bg: 'bg-white dark:bg-slate-800', border: 'border-slate-100 dark:border-slate-700', text: 'text-slate-800 dark:text-slate-100' };
                let icon = 'fa-book';
                let iconColor = 'text-slate-300 dark:text-slate-600';
                
                if (isLunch) {
                    theme = { bg: 'bg-amber-50/50 dark:bg-amber-900/10', border: 'border-amber-100 dark:border-amber-900/30 border-dashed', text: 'text-amber-800 dark:text-amber-500' };
                    icon = 'fa-utensils'; iconColor = 'text-amber-400';
                } else if (cls.type === 'freelance') {
                    theme = {
                         bg: 'bg-slate-50 dark:bg-slate-900/40 bg-[radial-gradient(#cbd5e1_1px,transparent_1px)] dark:bg-[radial-gradient(#334155_1px,transparent_1px)] [background-size:12px_12px]',
                         border: 'border-2 border-dashed border-slate-300 dark:border-slate-600',
                         text: 'text-slate-500 dark:text-slate-400 italic'
                    };
                    icon = 'fa-laptop'; iconColor = 'text-slate-400';
                } else if (cls.isLab) {
                    theme = { bg: 'bg-rose-50/80 dark:bg-rose-900/10', border: 'border-rose-100 dark:border-rose-900/30', text: 'text-slate-800 dark:text-slate-100' };
                    icon = 'fa-flask'; iconColor = 'text-rose-500';
                } else if (cls.isClinical) {
                    theme = { bg: 'bg-violet-50/80 dark:bg-violet-900/10', border: 'border-violet-100 dark:border-violet-900/30', text: 'text-slate-800 dark:text-slate-100' };
                    icon = 'fa-stethoscope'; iconColor = 'text-violet-500';
                } else {
                    const palette = getSubjectColor(cls.lines[0]);
                    theme.bg = `bg-white dark:bg-slate-800`;
                    theme.border = `border-l-4 ${palette.border.replace('border', 'border-l')}`;
                    iconColor = palette.text.split(' ')[0];
                }

                if (isNow) {
                    theme.bg = 'glow-border bg-white dark:bg-slate-800';
                    theme.border = 'border-transparent';
                    iconColor = 'text-blue-600';
                }

                // Badges
                let badges = '';
                if(cls.isLab) badges += `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-rose-100 text-rose-700 dark:bg-rose-900/50 dark:text-rose-300 border border-rose-200 dark:border-rose-800">${t.badgeLab}</span>`;
                if(cls.isClinical) badges += `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-violet-100 text-violet-700 dark:bg-violet-900/50 dark:text-violet-300 border border-violet-200 dark:border-violet-800">${t.badgeClinical}</span>`;
                
                // Active / Next Up Logic
                let nowBadge = '';
                if (isNow) {
                    const remaining = calculateRemaining(cls.time);
                    nowBadge = `<div class="absolute -top-3 right-4 bg-blue-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg shadow-blue-500/30 animate-pulse flex items-center gap-1"><i class="fas fa-clock"></i> <span>${t.endsIn} ${remaining}m</span></div>`;
                } else if (!hasActiveNow && targetDateStr === DateUtils.getTodayString()) {
                    // Check if this is the "Next Up" class
                    const minsToStart = calculateMinsToStart(cls.time);
                    if (minsToStart > 0 && minsToStart <= 60 && !hasActiveNow) { // only show for imminent next class
                        nowBadge = `<div class="absolute -top-3 right-4 bg-amber-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg shadow-amber-500/30 flex items-center gap-1"><i class="fas fa-hourglass-start"></i> <span>${t.startsIn} ${minsToStart}m</span></div>`;
                        hasActiveNow = true; // Prevent multiple "next up" badges
                    }
                }

                const card = document.createElement('div');
                card.className = `relative animate-fade-in-up mb-2 group ${isLast ? 'last-item' : ''}`;
                card.style.animationDelay = `${index * 0.05}s`;
                
                const timeColor = isNow ? 'text-blue-600 dark:text-blue-400 scale-110 font-black' : 'text-slate-400 dark:text-slate-500 font-bold';
                const circleBg = isNow ? 'bg-blue-600 ring-4 ring-blue-100 dark:ring-blue-900' : 'bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700';
                const circleIcon = isNow ? 'text-white' : iconColor;

                card.innerHTML = `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center w-14 pt-1 flex-shrink-0">
                            <span class="text-xs font-mono mb-2 ${timeColor} transition-transform">${cls.time}</span>
                            <div class="w-10 h-10 rounded-full flex items-center justify-center z-10 ${circleBg} transition-all shadow-sm">
                                <i class="fas ${icon} ${circleIcon} text-sm"></i>
                            </div>
                            <div class="time-connector w-0.5 bg-slate-200 dark:bg-slate-800 flex-1 my-2"></div>
                        </div>
                        <div class="flex-1 pb-6 min-w-0">
                            <div class="relative p-4 rounded-2xl border ${theme.bg} ${theme.border} shadow-sm transition-all hover:shadow-md">
                                ${nowBadge}
                                <div class="flex flex-wrap gap-2 mb-1.5">${badges}</div>
                                <h4 class="font-bold text-base leading-tight ${theme.text} mb-1">${cls.lines[0]}</h4>
                                ${cls.lines[1] ? `<p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2">${cls.lines[1]}</p>` : ''}
                                ${cls.lines.slice(2).map(l => `<div class="flex items-center gap-1.5 mt-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider"><i class="fas fa-user"></i> ${l}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            container.appendChild(fragment);
            
            setTimeout(() => {
                const active = container.querySelector('.glow-border');
                if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }

        // --- HELPERS ---

        function calculateRemaining(startTimeStr) {
            try {
                const [h, m] = startTimeStr.split(':').map(Number);
                const now = new Date();
                const endMins = (h * 60) + m + 50; 
                const curMins = (now.getHours() * 60) + now.getMinutes();
                return Math.max(0, endMins - curMins);
            } catch { return 0; }
        }

        function calculateMinsToStart(startTimeStr) {
            try {
                const [h, m] = startTimeStr.split(':').map(Number);
                const now = new Date();
                const startMins = (h * 60) + m;
                const curMins = (now.getHours() * 60) + now.getMinutes();
                return startMins - curMins;
            } catch { return -1; }
        }

        function updateNowBadgeTimer() {
            const el = document.querySelector('.glow-border span'); 
            if(el && el.innerText.includes('Ends')) { /* logic handled by refresh */ }
        }

        function checkIsNow(timeStr, targetDateStr) {
            if (targetDateStr !== DateUtils.getTodayString()) return false;
            try {
                const [h, m] = timeStr.split(':').map(Number);
                const now = new Date();
                const cur = (now.getHours() * 60) + now.getMinutes();
                const start = (h * 60) + m;
                return cur >= start && cur < (start + 50);
            } catch { return false; }
        }

        function showEmptyState(title, msg, icon) {
            const el = document.getElementById('emptyState');
            el.classList.remove('hidden');
            document.getElementById('txt-empty-title').textContent = title;
            document.getElementById('emptyIcon').innerHTML = icon;
            document.getElementById('txt-empty-desc').textContent = Array.isArray(msg) ? msg[0] : msg;
        }

        function updateDayProgress() {
            const now = new Date();
            const start = new Date().setHours(8, 30, 0);
            const end = new Date().setHours(17, 30, 0);
            const pct = Math.max(0, Math.min(100, ((now - start) / (end - start)) * 100));
            document.getElementById('dayProgressBar').style.width = `${pct}%`;
        }

        function hardReset() {
            if(confirm('Reset all data? This will fix sync issues but requires internet to reload schedule.')) {
                localStorage.clear();
                window.location.reload();
            }
        }

        function goToToday() {
            const today = DateUtils.getTodayString();
            document.getElementById('datePicker').value = today;
            renderDateStrip();
            refreshView();
        }

        function setLoading(b) { document.getElementById('loadingState').classList.toggle('hidden', !b); }
        function closeInstallModal() { document.getElementById('installModal').classList.add('hidden'); }
        function openInstallModal() { document.getElementById('installModal').classList.remove('hidden'); }
        function closeInstallBanner() { document.getElementById('installBanner').classList.add('hidden'); localStorage.setItem('installBannerDismissed', 'true'); }
        function checkInstallBanner() { if(!localStorage.getItem('installBannerDismissed') && !window.matchMedia('(display-mode: standalone)').matches) document.getElementById('installBanner').classList.remove('hidden'); }

        // --- FIXED DATA PARSING LOGIC ---
        
        function isRowBarrier(row) {
            if (!row || !Array.isArray(row)) return false;
            for (let i = 0; i < row.length; i++) {
                const val = row[i];
                if (!val) continue;
                if (typeof val === 'string' && val.match(/^\d{4}-\d{2}-\d{2}$/)) return true;
                if (typeof val === 'string') {
                    const s = val.toLocaleLowerCase('tr-TR').trim();
                    if (s.match(/^(committee|komite|phase|dÃ¶nem|week|hafta)\s*[\dIVX.]+$/i) || s === 'week' || s === 'hafta') return true;
                }
            }
            return false;
        }

        function getClassesForDate(dateStr) {
            if(!workbookData) return [];
            let rIdx = -1, cIdx = -1, isEn = currentLang === 'EN';
            for(let r=0; r<workbookData.length; r++) {
                const row = workbookData[r];
                for(let c=0; c<row.length; c++) {
                    if(row[c] === dateStr) {
                        if((isEn && c > CONFIG.SPLIT_COLUMN_INDEX) || (!isEn && c <= CONFIG.SPLIT_COLUMN_INDEX)) {
                            rIdx = r; cIdx = c; break;
                        }
                    }
                }
                if(rIdx !== -1) break;
            }
            if(rIdx === -1) return [];

            const items = [];
            let timeCol = -1;
            for(let offset=1; offset<=4; offset++) {
                const checkRow = workbookData[rIdx + offset];
                if(checkRow) {
                    for(let c=cIdx-1; c>=0; c--) {
                        if(String(checkRow[c]||"").match(/^\d{1,2}[:.]\d{2}/)) { timeCol = c; break; }
                    }
                }
                if(timeCol !== -1) break;
            }
            if(timeCol === -1) timeCol = isEn ? 9 : 0; 
            
            let r = rIdx + 1;
            const maxR = Math.min(workbookData.length, rIdx + 60);

            while(r < maxR) {
                const row = workbookData[r];
                if(isRowBarrier(row)) break; 

                const tVal = String(row[timeCol]||"").trim();
                const tMatch = tVal.match(/(\d{1,2})[:.](\d{2})/);
                
                if(tMatch) {
                    const time = `${tMatch[1]}:${tMatch[2]}`;
                    const lines = [];
                    const val = String(row[cIdx]||"").trim();
                    const isGarbage = (s) => !s || s.match(/^\d+$/) || ['mon','tue','wed','thu','fri'].some(d => s.toLowerCase().startsWith('('+d));

                    if(!isGarbage(val) && val.length > 2) lines.push(val);
                    
                    let subR = r + 1;
                    while(subR < maxR) {
                        const subRow = workbookData[subR];
                        if(isRowBarrier(subRow)) break; 
                        if(String(subRow[timeCol]||"").match(/\d{1,2}[:.]\d{2}/)) break; 
                        const subVal = String(subRow[cIdx]||"").trim();
                        if(!isGarbage(subVal) && subVal.length > 2 && !lines.includes(subVal)) lines.push(subVal);
                        subR++;
                    }
                    r = subR - 1; 
                    
                    if(lines.length > 0) {
                        const raw = lines.join(" ");
                        const { type, isLab, isClinical } = ClassTypeDetector.detect(raw);
                        items.push({ time, lines, type, isLab, isClinical, raw });
                    } else if (tMatch[1] == 12 || tMatch[1] == 13) {
                         items.push({ time, lines:[TRANSLATIONS[currentLang].lunch], type:'lunch' });
                    }
                }
                r++;
            }
            return items.filter((i, idx, self) => i.type !== 'lunch' || idx === self.findIndex(x => x.type === 'lunch'));
        }

        function handleGlobalSearch(q) {
            const term = q.toLowerCase();
            const cont = document.getElementById('searchResultsContainer');
            cont.innerHTML = '';
            cont.classList.remove('hidden');
            if(term.length < 2) return;

            if(searchIndexes[currentLang].length === 0) return;

            searchIndexes[currentLang].forEach(day => {
                const matches = day.items.filter(i => i.raw.toLowerCase().includes(term));
                if(matches.length) {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = "flex items-center gap-2 mt-4 mb-2 pl-1";
                    const dObj = DateUtils.parse(day.date);
                    const locale = currentLang === 'TR' ? 'tr-TR' : 'en-US';
                    const dateFormatted = dObj.toLocaleDateString(locale, { weekday: 'long', month: 'short', day: 'numeric' });
                    dateHeader.innerHTML = `<span class="text-xs font-bold text-blue-500 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded-md uppercase tracking-wide">${dateFormatted}</span>`;
                    cont.appendChild(dateHeader);
                    
                    matches.forEach(m => {
                        const el = document.createElement('div');
                        el.className = "bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 text-sm cursor-pointer hover:border-blue-400 active:scale-[0.98] transition-all";
                        el.innerHTML = `<div class="font-bold text-slate-700 dark:text-slate-200">${m.lines[0]}</div><div class="text-xs text-slate-400 mt-1 flex items-center gap-1"><i class="far fa-clock"></i> ${m.time}</div>`;
                        el.onclick = () => {
                            document.getElementById('datePicker').value = day.date;
                            renderDateStrip(); 
                            toggleSearch();
                        }
                        cont.appendChild(el);
                    });
                }
            });
        }

        function buildSearchIndexes() {
            if(!workbookData) return;
            searchIndexes = { EN: [], TR: [] };
            for(let r=0; r<workbookData.length; r++) {
                const row = workbookData[r];
                for(let c=0; c<row.length; c++) {
                    const d = DateUtils.normalize(row[c]);
                    if(d) {
                        const lang = c <= CONFIG.SPLIT_COLUMN_INDEX ? 'TR' : 'EN';
                        const items = getClassesForDate(d).filter(x => x.type !== 'lunch');
                        if(items.length) searchIndexes[lang].push({ date: d, items });
                    }
                }
            }
        }
        
        function generateMockData() {
            const rows = [];
            const dateRow = new Array(20).fill("");
            const today = new Date();
            for(let i=0; i<20; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + (i - 2)); 
                dateRow[i] = DateUtils.normalize(d);
            }
            rows.push(dateRow);
            for(let i=0; i<4; i++) rows.push(new Array(20).fill(""));

            const times = ["08:30", "09:30", "10:30", "11:30", "12:30", "13:30", "14:30", "15:30", "16:30"];
            const subjsEN = ["Anatomy", "Histology", "Physiology", "Biochemistry", "Public Health", "Biophysics"];
            const subjsTR = ["Anatomi", "Histoloji", "Fizyoloji", "Biyokimya", "Halk SaÄŸlÄ±ÄŸÄ±", "Biyofizik"];
            times.forEach(t => {
                const row = new Array(20).fill("");
                row[0] = t; row[9] = t;
                for(let c=0; c<20; c++) {
                    if(c === 0 || c === 9) continue;
                    const dStr = dateRow[c];
                    if(dStr) {
                         const d = DateUtils.parse(dStr);
                         if(d.getDay() === 0 || d.getDay() === 6) continue;
                    }
                    if(Math.random() > 0.4) {
                        if(t === "12:30" || t === "13:30") row[c] = (c < 8) ? "Ã–ÄŸle ArasÄ±" : "Lunch";
                        else {
                            const pool = (c < 8) ? subjsTR : subjsEN;
                            row[c] = pool[Math.floor(Math.random() * pool.length)] + (Math.random() > 0.7 ? " (Lab)" : "");
                        }
                    }
                }
                rows.push(row);
            });
            return rows;
        }
    </script>
</body>
</html>
